#' Ratchet bootstrapper
#' 
#' @template edgeListParam
#' @template morphyObjParam
#' @template EdgeSwapperParam
#' @param maxIter maximum number of iterations to perform in tree search
#' @param maxHits maximum number of hits to accomplish in tree search
#' @template stopAtPeakParam
#' @template stopAtPlateauParam
#' @template verbosityParam
#' @param \dots further parameters to send to \code{TreeScorer}
#'
#' @references 
#' - \insertRef{SmithTern}{TreeSearch}
#'
#' @return A tree that is optimal under a random sampling of the original
#' characters
#' @export
MorphyBootstrap <- function (edgeList, morphyObj, EdgeSwapper = NNISwap, 
                             maxIter, maxHits, verbosity=1L, stopAtPeak=FALSE,
                             stopAtPlateau=0L, ...) {
  startWeights <- MorphyWeights(morphyObj)[1, ]
  eachChar <- seq_along(startWeights)
  deindexedChars <- rep(eachChar, startWeights)
  resampling <- tabulate(sample(deindexedChars, replace=TRUE), 
                         length(startWeights))
  errors <- vapply(eachChar, function (i) 
            mpl_set_charac_weight(i, resampling[i], morphyObj), integer(1))
  
  if (any(errors)) {
    stop ("Error resampling morphy object: ", 
          mpl_translate_error(unique(errors[errors < 0L])))
  }
  
  if (mpl_apply_tipdata(morphyObj) -> error) {
    stop("Error applying tip data: ", mpl_translate_error(error))
  }
  
  res <- EdgeListSearch(edgeList[1:2], morphyObj, EdgeSwapper = EdgeSwapper,
                        maxIter = maxIter, maxHits = maxHits,
                        stopAtPeak = stopAtPeak, stopAtPlateau = stopAtPlateau, 
                        verbosity = verbosity - 1L, ...)
  
  errors <- vapply(eachChar, 
                   function (i) mpl_set_charac_weight(i, startWeights[i],
                                                      morphyObj), 
                   integer(1))
  if (any(errors)) {
    stop ("Error resampling morphy object: ",
          mpl_translate_error(unique(errors[errors < 0L])))
  }
  if (mpl_apply_tipdata(morphyObj) -> error) {
    stop("Error applying tip data: ", mpl_translate_error(error))
  }
  
  # Return:
  res[1:2]
}

MorphyBootstrapMatrix <- function (edgeMatrix, morphyObj, maxHits, 
                                   TreeScorer = MorphyLength,
                                   ProposedMoves = RootedTBRSwapAll,
                                   maxQueue = 1e06,
                                   verbosity=1L, ...) {
  
  startWeights <- MorphyWeights(morphyObj)[1, ]
  eachChar <- seq_along(startWeights)
  deindexedChars <- rep(eachChar, startWeights)
  resampling <- tabulate(sample(deindexedChars, replace=TRUE), 
                         length(startWeights))
  errors <- vapply(eachChar, function (i) 
    mpl_set_charac_weight(i, resampling[i], morphyObj), integer(1))
  
  if (any(errors)) {
    stop ("Error resampling morphy object: ", 
          mpl_translate_error(unique(errors[errors < 0L])))
  }
  
  if (mpl_apply_tipdata(morphyObj) -> error) {
    stop("Error applying tip data: ", mpl_translate_error(error))
  }
  
  ret <- EdgeMatrixSearch(edgeMatrix, morphyObj, TreeScorer = TreeScorer,
                          ProposedMoves = ProposedMoves, maxHits = maxHits,
                          maxQueue = maxQueue, verbosity = verbosity - 1L, ...)

  errors <- vapply(eachChar, 
                   function (i) mpl_set_charac_weight(i, startWeights[i],
                                                      morphyObj), 
                   integer(1))
  if (any(errors)) {
    stop ("Error resampling morphy object: ",
          mpl_translate_error(unique(errors[errors < 0L])))
  }
  if (mpl_apply_tipdata(morphyObj) -> error) {
    stop("Error applying tip data: ", mpl_translate_error(error))
  }
  
  # Return:
  ret
}

#' @describeIn MorphyBootstrap Bootstrapper for Profile Parsimony
#' @template datasetParam
#' @export
ProfileBootstrap <- function (edgeList, dataset, EdgeSwapper = NNISwap, 
                              maxIter, maxHits, verbosity=1L, ...) {
  att <- attributes(dataset)
  startWeights <- att[['weight']]
  eachChar <- seq_along(startWeights)
  deindexedChars <- rep(eachChar, startWeights)
  resampling <- tabulate(sample(deindexedChars, replace=TRUE), 
                         length(startWeights))
  sampled <- resampling != 0
  sampledData <- lapply(dataset, function (x) x[sampled])
  sampledAtt <- att
  sampledAtt[['weight']] <- resampling[sampled]
  sampledAtt[['index']] <- rep(seq_len(sum(sampled)), resampling[sampled])
  sampledAtt[['info.amounts']] <- att[['info.amounts']][, sampled]
  sampledAtt[['morphyObjs']] <- att[['morphyObjs']][sampled]
  attributes(sampledData) <- sampledAtt
  
  res <- EdgeListSearch(edgeList[1:2], sampledData, 
                        TreeScorer = ProfileScoreMorphy,
                        EdgeSwapper = EdgeSwapper, maxIter = maxIter,
                        maxHits = maxHits, verbosity = verbosity-1L, ...)
  
  # Return:
  res[1:2]
}

#' @describeIn MorphyBootstrap Bootstrapper for Implied weighting
#' @template concavityParam
#' @export
IWBootstrap <- function (edgeList, dataset, concavity = 10L,
                         EdgeSwapper = NNISwap, maxIter, maxHits, 
                         verbosity=1L, ...) {
  att <- attributes(dataset)
  startWeights <- att[['weight']]
  eachChar <- seq_along(startWeights)
  deindexedChars <- rep(eachChar, startWeights)
  resampling <- tabulate(sample(deindexedChars, replace=TRUE), length(startWeights))
  sampled <- resampling != 0
  sampledData <- lapply(dataset, function (x) x[sampled])
  sampledAtt <- att
  sampledAtt[['weight']] <- resampling[sampled]
  sampledAtt[['index']] <- rep(seq_len(sum(sampled)), resampling[sampled])
  sampledAtt[['min.length']] <- minLength <- att[['min.length']][sampled] # Can probably delete but I'm too nervous to... MS, 2018-03-06
  sampledAtt[['morphyObjs']] <- att[['morphyObjs']][sampled]
  attributes(sampledData) <- sampledAtt
  
  res <- EdgeListSearch(edgeList[1:2], sampledData, TreeScorer=IWScoreMorphy,
                        concavity=concavity, minLength = minLength,
                        EdgeSwapper=EdgeSwapper, maxIter=maxIter, maxHits=maxHits,
                        verbosity=verbosity-1L)
  
  res[1:2]
}

#' @describeIn MorphyBootstrapMatrix Bootstrapper for Implied weighting
#' @template concavityParam
#' @export
IWBootstrapMatrix <- function (edgeMatrix, dataset, concavity = 10L,
                               maxHits, ProposedMoves = RootedTBRSwapAll,
                               TreeScorer = IWScoreMorphy,
                               maxQueue = 1e06, verbosity = 1L, ...) {
  
  att <- attributes(dataset)
  startWeights <- att[['weight']]
  eachChar <- seq_along(startWeights)
  deindexedChars <- rep(eachChar, startWeights)
  resampling <- tabulate(sample(deindexedChars, replace=TRUE), length(startWeights))
  sampled <- resampling != 0
  sampledData <- lapply(dataset, function (x) x[sampled])
  sampledAtt <- att
  sampledAtt[['weight']] <- resampling[sampled]
  sampledAtt[['index']] <- rep(seq_len(sum(sampled)), resampling[sampled])
  sampledAtt[['min.length']] <- minLength <- att[['min.length']][sampled] # Can probably delete but I'm too nervous to... MS, 2018-03-06
  sampledAtt[['morphyObjs']] <- att[['morphyObjs']][sampled]
  attributes(sampledData) <- sampledAtt
  
  # Return:
  EdgeMatrixSearch(edgeMatrix, sampledData, TreeScorer = TreeScorer,,
                   concavity = concavity, ProposedMoves = ProposedMoves, 
                   maxHits = maxHits, maxQueue = maxQueue, 
                   verbosity = verbosity - 1L, ...)
  
}
